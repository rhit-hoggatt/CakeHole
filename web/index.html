<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>DNS Server Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .navbar {
            width: 100%;
            background-color: #007bff56;
            display: flex;
            justify-content: center;
            padding: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .tab-button:hover {
            background-color: #0056b3;
        }
        .tab-button:focus {
            outline: none;
            background-color: #0056b3;
        }
        .tab-content {
            display: none;
        }
        #home-tab {
            display: block; /* Show the home tab by default */
        }
        .row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 10px 0;
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .box {
            min-width: 200px;
            min-height: 50px;
            margin: 10px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #f9f9f9;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            word-break: break-word;
        }
        .box h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        .box p {
            margin: 10px 0 0;
            font-size: 24px;
            font-weight: bold;
            color: #007BFF;
        }
        button {
            margin: 0px 0px 0px 15px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:active {
            transform: scale(0.98);
        }
        .adlists-table {
            width: 80%;
            border-collapse: collapse;
            margin: 20px auto;
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .adlists-table th, .adlists-table td {
            padding: 12px 16px;
            text-align: center;
        }
        .adlists-table th {
            background-color: #007BFF;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            border-bottom: 2px solid #0056b3;
        }
        .adlists-table tr {
            transition: background-color 0.2s;
        }
        .adlists-table tr:nth-child(even) {
            background-color: #e9f2ff;
        }
        .adlists-table tr:hover {
            background-color: #d0e7ff;
        }
        .adlists-table td {
            font-size: 15px;
            color: #333;
            border-bottom: 1px solid #ccc;
        }
        .adlists-table td:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

    <div class="navbar">
        <button class="tab-button" onclick="showTab('home')">Home</button>
        <button class="tab-button" onclick="showTab('adlists')">Adlists</button>
        <button class="tab-button" onclick="showTab('localDNS')">Local DNS</button>
        <button class="tab-button" onclick="showTab('performance')">Performance</button>
        <button class="tab-button" onclick="showTab('terminal')">Terminal</button>
        <button class="tab-button" onclick="restartDNS()" style="margin-left: auto;">Restart DNS Server</button>
        <button class="tab-button" onclick="logout()" style="margin-left: 10px;">Logout</button>
    </div>

    <div id="home-tab" class="tab-content">
        <div class="row">
            <h1>DNS Server Status</h1>
        </div>
        <div class="row">
            <h2>Server Status: <span id="server-status">Blocking</span></h2>
            <button id="enable-blocking" onclick="enableBlocking()">Enable Blocking</button>
            <button id="disable-blocking" onclick="disableBlocking()">Disable Blocking</button>
        </div>
        <div class="row container">
            <div class="box">
                <h2>Total Queries</h2>
                <p id="total-queries">0</p>
            </div>
            <div class="box">
                <h2>Total Blocked Queries</h2>
                <p id="total-blocked">0</p>
            </div>
            <div class="box">
                <h2>Percentage Blocked</h2>
                <p id="percentage-blocked">0%</p>
            </div>
            <div class="box">
                <h2>Domains on Adlists</h2>
                <p id="domains-on-adlists">0</p>
            </div>
        </div>
        <div class="row container">
            <div class="box">
                <h2>Values in Cache</h2>
                <p id="cached-values">0</p>
            </div>
            <div class="box">
                <h2>Cache Hits</h2>
                <p id="cache-hits">0</p>
            </div>
            <div class="box">
                <h2>Requests Queued</h2>
                <p id="requests-queued">0%</p>
            </div>
        </div>
        <div class="row">
            <div style="width: 80%; height: 400px;">
                <canvas id="queryGraph"></canvas>
            </div>
        </div>
    </div>

    <div id="adlists-tab" class="tab-content" style="display: none;">
        <div class="row">
            <h1>Adlists Management</h1>
        </div>
        <div class="row">
            <button onclick="reloadAdlists()">Reload All Adlists</button>
            <button onclick="addAdlist()">Add Adlist</button>
        </div>
        <div class="row">
            <table class="adlists-table">
                <thead>
                    <tr>
                        <th>Adlist URL</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adlists-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <div id="localDNS-tab" class="tab-content" style="display: none;">
        <div class="row">
            <h1>Local Domain Management</h1>
        </div>
        <div class="row">
            <button onclick="openAddDomainModal()">Add Domain</button>
        </div>
        <div class="row">
            <table class="adlists-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Domain</th>
                        <th>IP</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="localDNS-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <div id="performance-tab" class="tab-content" style="display: none;">
        <div class="row">
            <h1>Performance Settings</h1>
        </div>
        <div class="row">
            <label for="threads" style="font-size:18px; font-weight:bold; margin-right:10px;">Num Query Response Processes:</label>
            <input type="number" id="threads" min="1" style="width:70px; font-size:18px; padding:5px; border-radius:5px; border:1px solid #ccc;" />
            <button onclick="setNumThreads()" style="margin-left:10px;">Set</button>
            <script>
                let needsRestart = false;
                async function setNumThreads() {
                    const num = parseInt(document.getElementById('threads').value, 10);
                    const prev = await fetch('/api/getNumThreads').then(r => r.json()).then(d => d.numThreads);
                    if (num === prev) {
                        alert('Number of threads is already set to this value.');
                        return;
                    }
                    if (isNaN(num) || num < 1) {
                        alert('Please enter a valid number greater than 0.');
                        return;
                    }
                    try {
                        const response = await fetch('/api/setNumThreads', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ numThreads: num })
                        });
                        if (!response.ok) throw new Error('Network response was not ok');

                        const restartBtn = document.querySelector('.tab-button[onclick="restartDNS()"]');
                        if (restartBtn) {
                            restartBtn.style.backgroundColor = 'red';
                            restartBtn.style.color = 'white';
                            restartBtn.textContent = 'Restart DNS Server (Required)';
                        }
                        alert('Number of threads updated. Please restart the DNS server for changes to take effect.');
                        needsRestart = true;
                    } catch (error) {
                        alert('Error setting number of threads: ' + error);
                    }
                }
            </script>
            
        </div>
        <div class="row container">
            <div class="box">
                <h2>Avg Cache Lookup Time</h2>
                <p id="cache-lookup">0</p>
            </div>
            <div class="box">
                <h2>Avg Cached Response Time</h2>
                <p id="cache-response">0</p>
            </div>
            <div class="box">
                <h2>Avg Non-Cached Response Time</h2>
                <p id="NC-response">0%</p>
            </div>
        </div>
        <div class="row">
            <div class="row">
            <label for="upstream-dns-input" style="font-size:18px; font-weight:bold; margin-right:10px;">Upstream DNS Server:</label>
            <select id="upstream-dns-select" style="font-size:16px; padding:5px 10px; border-radius:5px; border:1px solid #ccc; margin-right:10px;">
                <option value="8.8.8.8">Google (8.8.8.8)</option>
                <option value="1.1.1.1">Cloudflare (1.1.1.1)</option>
                <option value="custom">Custom...</option>
            </select>
            <input type="text" id="upstream-dns-input" style="width:160px; font-size:16px; padding:5px; border-radius:5px; border:1px solid #ccc; margin-right:10px;" />
            <button onclick="setUpstreamDNS()">Set</button>
        </div>
        <script>
            async function fetchUpstreamDNS() {
                try {
                    const response = await fetch('/api/getUpstreamDNS');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    const current = data.upstreamDNS;
                    const select = document.getElementById('upstream-dns-select');
                    const input = document.getElementById('upstream-dns-input');
                    if (current === "8.8.8.8" || current === "1.1.1.1") {
                        select.value = current;
                        input.value = current;
                        input.disabled = true;
                    } else {
                        select.value = "custom";
                        input.value = current;
                        input.disabled = false;
                    }
                } catch (error) {
                    console.error('Error fetching upstream DNS:', error);
                }
            }
            document.getElementById('upstream-dns-select').addEventListener('change', function() {
                const input = document.getElementById('upstream-dns-input');
                if (this.value === "custom") {
                    input.disabled = false;
                    input.value = "";
                    input.focus();
                } else {
                    input.disabled = true;
                    input.value = this.value;
                }
            });
            async function setUpstreamDNS() {
                const select = document.getElementById('upstream-dns-select');
                let value = select.value === "custom" ? document.getElementById('upstream-dns-input').value.trim() : select.value;
                if (!value) {
                    alert('Please enter a valid DNS IP.');
                    return;
                }
                try {
                    const response = await fetch('/api/setUpstreamDNS', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ upstreamDNS: value })
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    await fetchUpstreamDNS();
                } catch (error) {
                    alert('Error setting upstream DNS: ' + error);
                }
            }
            fetchUpstreamDNS();
        </script>
        </div>
    </div>

    <div id="terminal-tab" class="tab-content" style="display: none;">
        <div class="row">
            <h1>Terminal</h1>
        </div>
        <div class="row" style="width: 100%; margin: 20px 0;">
            <div style="width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 10px; 
            background-color: #f9f9f9; overflow-y: auto; padding: 10px; font-family: monospace; 
            font-size: 14px; color: #333;" id="terminal-output"></div>
        </div>
        <div class="row">
            <button onclick="clearTerminal()">Clear Terminal</button>
            <label for="refresh-time" style="margin-left: 15px;">Refresh Time (seconds):</label>
            <select id="refresh-time" onchange="changeRefreshTime(this.value)" style="margin-left: 10px; padding: 5px 10px; font-size: 16px; 
            font-weight: bold; color: #fff; background-color: #007BFF; border: none; border-radius: 5px; cursor: pointer; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: background-color 0.3s ease;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="30">30</option>
                <option value="60">60</option>
                <option value="-1">Disable</option>
            </select>
        </div>
    </div>
    <div id="add-domain-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.12); padding:32px 28px; min-width:320px; display:flex; flex-direction:column; align-items:center;">
            <h2 style="color:#007BFF; margin-bottom:20px;">Add Local Domain</h2>
            <label style="align-self:flex-start; margin-bottom:4px; color:#333;">Name:</label>
            <input id="modal-domain-name" type="text" style="width:100%; margin-bottom:12px; padding:10px; border-radius:5px; border:1px solid #ccc; font-size:15px;">
            <label style="align-self:flex-start; margin-bottom:4px; color:#333;">Domain:</label>
            <input id="modal-domain-domain" type="text" style="width:100%; margin-bottom:12px; padding:10px; border-radius:5px; border:1px solid #ccc; font-size:15px;">
            <label style="align-self:flex-start; margin-bottom:4px; color:#333;">IP Address:</label>
            <input id="modal-domain-ip" type="text" style="width:100%; margin-bottom:20px; padding:10px; border-radius:5px; border:1px solid #ccc; font-size:15px;">
            <div style="display:flex; width:100%; justify-content:space-between;">
                <button onclick="closeAddDomainModal()" style="background:#ccc; color:#333; margin-right:10px;">Cancel</button>
                <button onclick="submitAddDomain()" style="background:#007BFF;">Submit</button>
            </div>
        </div>
    </div>

    <script>
        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/';
                    } else {
                        console.error('Logout failed');
                    }
                })
                .catch(error => {
                    console.error('Error during logout:', error);
                });
        }

        function deleteDomain(domain) {
            fetch('/api/deleteLocalDomain', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain }),
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                fetchLocalDomains();
            })
            .catch(error => {
                console.error('Error deleting local domain:', error);
            });
        }

        function fetchLocalDomains() {
            fetch('/api/getLocalDomains')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('localDNS-table-body');
                    tableBody.innerHTML = ''; // Clear existing rows
                    data.forEach(domain => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${domain.name}</td>
                            <td>${domain.domain}</td>
                            <td>${domain.ip}</td>
                            <td>
                                <button onclick="deleteDomain('${domain.domain}')">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching local domains:', error);
                });
        }
        fetchLocalDomains();

        function openAddDomainModal() {
            document.getElementById('modal-domain-name').value = '';
            document.getElementById('modal-domain-domain').value = '';
            document.getElementById('modal-domain-ip').value = '';
            document.getElementById('add-domain-modal').style.display = 'flex';
        }

        function closeAddDomainModal() {
            document.getElementById('add-domain-modal').style.display = 'none';
        }

        function submitAddDomain() {
            const name = document.getElementById('modal-domain-name').value.trim();
            const domain = document.getElementById('modal-domain-domain').value.trim();
            const ip = document.getElementById('modal-domain-ip').value.trim();
            if (domain && ip) {
                fetch('/api/addLocalDomain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, domain, ip }),
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    fetchLocalDomains();
                    closeAddDomainModal();
                })
                .catch(error => {
                    alert('Error adding local domain: ' + error);
                });
            } else {
                alert('Please fill in all fields.');
            }
        }

        let refreshInterval = 500;
        let refreshTimer;

        function changeRefreshTime(seconds) {
            if (seconds == -1) {
                clearInterval(refreshTimer);
                return;
            }
            clearInterval(refreshTimer);
            refreshInterval = seconds * 1000;
            startFetchingTerminalOutput();
        }

        function startFetchingTerminalOutput() {
            fetchTerminalOutput(); // Fetch immediately
            refreshTimer = setInterval(fetchTerminalOutput, refreshInterval);
        }

        function clearTerminal() {
            const terminalOutput = document.getElementById('terminal-output');
            terminalOutput.innerHTML = '<p></p>';
        }

        function appendToTerminalOutput(data) {
            const terminalOutput = document.getElementById('terminal-output');
            const lines = data.split('\n'); // Split data by newline characters
            lines.forEach(line => {
                const newLine = document.createElement('p');
                newLine.textContent = line;
                terminalOutput.appendChild(newLine);
            });
            terminalOutput.scrollTop = terminalOutput.scrollHeight; // Auto-scroll to the bottom
        }

        async function fetchTerminalOutput() {
            try {
                const response = await fetch('/api/terminalOutput');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                clearTerminal();
                appendToTerminalOutput(data.output);
            } catch (error) {
                console.error('Error fetching terminal output:', error);
            }
        }
        startFetchingTerminalOutput();

        async function restartDNS() {
            try {
                const response = await fetch('/api/restartDNS', { method: 'POST' });
                if (needsRestart) {
                    const restartBtn = document.querySelector('.tab-button[onclick="restartDNS()"]');
                    if (restartBtn) {
                        restartBtn.style.backgroundColor = '#007BFF';
                        restartBtn.style.color = 'white';
                        restartBtn.textContent = 'Restart DNS Server';
                    }
                    needsRestart = false;
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                console.log('DNS server restarted:', data);
            } catch (error) {
                console.error('Error restarting DNS server:', error);
            }
        }

        async function fetchAdlists() {
            try {
                const response = await fetch('/api/getAdlists');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const adlistsJSON = await response.json();
                const tableBody = document.getElementById('adlists-table-body');
                tableBody.innerHTML = '';

                const adlists = adlistsJSON.data;
                adlists.split(',').forEach((adlist, index) => {
                    const [url, status] = adlist.split(' '); // Split each element into URL and status
                    const row = document.createElement('tr');

                    const urlCell = document.createElement('td');
                    urlCell.textContent = url;
                    row.appendChild(urlCell);

                    const statusCell = document.createElement('td');
                    statusCell.textContent = status; // Use the status from the data
                    statusCell.style.padding = '5px 10px';
                    statusCell.style.borderRadius = '5px';
                    statusCell.style.color = 'white';
                    statusCell.style.fontWeight = 'bold';
                    statusCell.style.backgroundColor = status === 'enabled' ? 'green' : 'red';
                    row.appendChild(statusCell);

                    const actionCell = document.createElement('td');
                    const toggleButton = document.createElement('button');
                    toggleButton.textContent = status === 'enabled' ? 'disable' : 'enable';
                    toggleButton.onclick = () => {
                        const isEnabled = toggleButton.textContent === 'disable';
                        if (isEnabled) {
                            fetch('/api/disableSpecificAdlist', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url }), // Send the adlist URL in the request body
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('Adlist disabled:', data);
                                    fetchAdlists();
                                })
                                .catch(error => {
                                    console.error('Error disabling adlist:', error);
                                });
                        } else {
                            fetch('/api/enableSpecificAdlist', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url }), // Send the adlist URL in the request body
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('Adlist enabled:', data);
                                    fetchAdlists();
                                })
                                .catch(error => {
                                    console.error('Error enabling adlist:', error);
                                });
                        }
                        toggleButton.textContent = isEnabled ? 'enable' : 'disable';
                        statusCell.textContent = isEnabled ? 'disabled' : 'enabled';
                        statusCell.style.backgroundColor = isEnabled ? 'red' : 'green';
                    };
                    actionCell.appendChild(toggleButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = () => {
                        fetch('/api/removeAdlist', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url }), // Send the adlist URL in the request body
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Adlist deleted:', data);
                                fetchAdlists();
                            })
                            .catch(error => {
                                console.error('Error deleting adlist:', error);
                            });
                    };
                    actionCell.appendChild(deleteButton);
                    actionCell.style.display = 'flex';
                    actionCell.style.justifyContent = 'space-between';
                    actionCell.style.alignItems = 'center';

                    row.appendChild(actionCell);

                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching adlists:', error);
            }
        }

        async function addAdlist() {
            const url = prompt('Enter the URL of the adlist:');
            if (url) {
                try {
                    const response = await fetch('/api/addAdlist', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });
                    if (!response.ok) {
                        throw new Error('Failed to add adlist');
                    } else {
                        const data = await response.json();
                        console.log('Adlist added:', data);
                    }
                    fetchAdlists(); // Refresh the table
                } catch (error) {
                    console.error('Error adding adlist:', error);
                }
            }
        }

        async function reloadAdlists() {
            try {
                const response = await fetch('/api/reloadAdlists', { method: 'POST' });
                if (!response.ok) {
                    throw new Error('Failed to reload adlists');
                }
                console.log('Adlists reloaded successfully');
                fetchAdlists(); // Refresh the table
            } catch (error) {
                console.error('Error reloading adlists:', error);
            }
        }

        document.querySelector('.tab-button[onclick="showTab(\'adlists\')"]').addEventListener('click', fetchAdlists);

        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.style.display = 'none'; // Hide all tabs
            });

            document.getElementById(`${tabId}-tab`).style.display = 'block'; // Show the selected tab
        }

        async function getNumThreads() {
            try {
                const response = await fetch('/api/getNumThreads');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                document.getElementById('threads').value = data.numThreads;
            } catch (error) {
                console.error('Error fetching number of threads:', error);
            }
        }

        async function getAvgCacheLookupTime() {
            try {
            const response = await fetch('/api/getAvgCacheLookupTime');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            // Convert seconds to milliseconds
            const ms = Number(data.avgCacheLookupTime) * 1000;
            document.getElementById('cache-lookup').textContent = ms.toFixed(3) + ' ms';
            } catch (error) {
            console.error('Error fetching average cache lookup time:', error);
            }
        }

        async function getAvgCacheResponseTime() {
            try {
            const response = await fetch('/api/getAvgCacheResponseTime');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            // Convert seconds to milliseconds
            const ms = Number(data.avgCacheResponseTime) * 1000;
            document.getElementById('cache-response').textContent = ms.toFixed(3) + ' ms';
            } catch (error) {
            console.error('Error fetching average cache response time:', error);
            }
        }

        async function getAvgNonCachedResponseTime() {
            try {
            const response = await fetch('/api/getAvgNonCachedResponseTime');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            // Convert seconds to milliseconds
            const ms = Number(data.avgAvgNCResponseTime) * 1000;
            document.getElementById('NC-response').textContent = ms.toFixed(3) + ' ms';
            } catch (error) {
            console.error('Error fetching average non-cached response time:', error);
            }
        }

        async function updateStats() {
            try {
                let queryDataJson = await getNumQueries();
                if (queryDataJson === undefined) {
                    console.error('Failed to fetch query data');
                    return;
                } 
                document.getElementById('total-queries').textContent = queryDataJson.processed;
                document.getElementById('total-blocked').textContent = queryDataJson.blocked;
                const percentageBlocked = await getPercentageBlocked();
                document.getElementById('percentage-blocked').textContent = percentageBlocked;
                document.getElementById('cached-values').textContent = queryDataJson.cache;
                document.getElementById('cache-hits').textContent = queryDataJson.hits;
                document.getElementById('requests-queued').textContent = queryDataJson.queue;
                await getAvgCacheLookupTime();
                await getAvgCacheResponseTime();
                await getAvgNonCachedResponseTime();
                await getDomainsOnAdlists();
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        getNumThreads();
    
        function enableBlocking() {
            fetch('/api/enableAdList', {
                method: 'POST',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Ad cache enabled:', data);
                document.getElementById('server-status').textContent = 'Blocking';
            })
            .catch(error => {
                console.error('Error enabling ad cache:', error);
            });
        }
    
        function disableBlocking() {
            fetch('/api/disableAdList', {
                method: 'POST',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Ad cache disabled:', data);
                document.getElementById('server-status').textContent = 'Not Blocking';
            })
            .catch(error => {
                console.error('Error disabling ad cache:', error);
            });
        }

        function disableBlockingForTime(time){
            try {
                disableBlocking();
                console.log('Ad cache disabled for', time, 'seconds');
                setTimeout(() => {
                    enableBlocking();
                }, time * 1000);
            } catch (error) {
                console.error('Error disabling ad cache for time:', error);
            }
        }

        async function getNumQueries() {
            try {
                const response = await fetch('/api/numQueries');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                
                return data;
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
                return 0;
            }
        }
    
        async function getPercentageBlocked() {
            const totalQueries = parseInt(document.getElementById('total-queries').textContent);
            const totalBlocked = parseInt(document.getElementById('total-blocked').textContent);
            if (totalQueries > 0) {
                const percentage = (totalBlocked / totalQueries) * 100;
                return percentage.toFixed(2) + '%';
            } else {
                return '0%';
            }
        }
    
        function getDomainsOnAdlists() {
            fetch('/api/domainsInAdlist')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('domains-on-adlists').textContent = data.domainsInAdlist;
                })
                .catch(error => {
                    console.error('Error fetching domains on adlists:', error);
                });
        }
        updateStats();
        setInterval(updateStats, 1000);

        const queryData = []; // This will now store ALLOWED queries
        const blockedData = []; // This will store BLOCKED queries
        const labels = [];
        const maxDataPoints = 120;

        const ctx = document.getElementById('queryGraph').getContext('2d');
        const queryChart = new Chart(ctx, {
            type: 'bar', // Changed from 'line' to 'bar'
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Blocked Queries', 
                        data: blockedData,
                        backgroundColor: 'rgba(255, 0, 0, 0.7)',
                        borderColor: '#FF0000',
                        borderWidth: 1
                    },
                    {
                        label: 'Allowed Queries',
                        data: queryData, 
                        backgroundColor: 'rgba(0, 123, 255, 0.7)', 
                        borderColor: '#007BFF',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false, // Good for performance with frequent updates
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time',
                        },
                        stacked: true, // Enable stacking on the X-axis
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Number of Queries',
                        },
                        beginAtZero: true,
                        stacked: true, // Enable stacking on the Y-axis
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index', // Show tooltip for all datasets at that index
                        intersect: false,
                    }
                }
            }
        });

        // Function to update the graph
        function updateGraph() {
            fetch('/api/graphData')
            .then(response => response.json())
            .then(data => {
                labels.length = 0;
                queryData.length = 0;
                blockedData.length = 0;

                data.labels.forEach((label, index) => {
                    labels.push(label);
                    const totalQueriesFromAPI = data.queries[index];
                    const blockedQueriesFromAPI = data.blocked[index];

                    const allowedQueries = totalQueriesFromAPI - blockedQueriesFromAPI;

                    queryData.push(allowedQueries); 
                    blockedData.push(blockedQueriesFromAPI); 
                });

                if (labels.length > maxDataPoints) {
                    const excess = labels.length - maxDataPoints;
                    labels.splice(0, excess);
                    queryData.splice(0, excess);
                    blockedData.splice(0, excess);
                }
                
                queryChart.update();
            })
            .catch(error => {
                console.error('Error fetching graph data:', error);
            });
        }

        updateGraph();
        setInterval(updateGraph, 60000 * 5); 
    </script>
</body>
</html>